<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Generate Montana Child Support Worksheets</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:16px;max-width:900px}
    label{display:block;margin:6px 0}
    input[type=number]{width:220px;max-width:100%;padding:4px 6px;box-sizing:border-box}
    button{padding:8px 12px;border-radius:6px;border:1px solid #ccc;background:#0b6efd;color:#fff;cursor:pointer}
    button:hover{background:#0954c8}
    .result{margin-top:12px;padding:10px;border-radius:8px;background:#f3f6fb}
  </style>
</head>
<body>
  <h1>Montana Child Support â€“ Worksheet Generator</h1>
  <p><small>This professional page runs the full guideline engine and builds Worksheet PDFs once templates exist.</small></p>

  <section>
    <h2>Quick inputs (for testing)</h2>
    <label>Parent A (Mother) annual gross $
      <input type="number" id="mIncome" step="0.01" value="43000">
    </label>
    <label>Parent A deductions $
      <input type="number" id="mDed" step="0.01" value="6000">
    </label>

    <label>Parent B (Father) annual gross $
      <input type="number" id="fIncome" step="0.01" value="30000">
    </label>
    <label>Parent B deductions $
      <input type="number" id="fDed" step="0.01" value="4000">
    </label>

    <label>Number of children
      <input type="number" id="numChildren" min="1" max="8" value="1">
    </label>

    <label>Annual childcare (total) $
      <input type="number" id="childcare" step="0.01" value="0">
    </label>
    <label>Annual child health premium $
      <input type="number" id="health" step="0.01" value="0">
    </label>

    <label>Days per year with Parent A (per child)
      <input type="number" id="daysA" step="0.1" value="255">
    </label>
    <label>Days per year with Parent B (per child)
      <input type="number" id="daysB" step="0.1" value="110">
    </label>

    <button id="runBtn">Run calculation & download worksheets</button>
  </section>

  <div id="out" class="result" style="display:none"></div>

  <script type="module">
    import { runMontanaChildSupport, fmt } from "/shared/engine.js";
    import { PDFDocument } from "https://cdn.skypack.dev/pdf-lib@1.17.1";

    async function generateWorksheets(calc) {
      // Load Worksheet A template
      const wsABytes = await fetch("/templates/WorksheetA-template.pdf").then(r => r.arrayBuffer());
      const wsADoc = await PDFDocument.load(wsABytes);
      const formA = wsADoc.getForm();

      // EXAMPLE FIELD NAMES (you will replace these with real ones later)
      formA.getTextField("A_L3_mother").setText(String(calc.worksheetA.mother.L3));
      formA.getTextField("A_L3_father").setText(String(calc.worksheetA.father.L3));
      formA.getTextField("A_L7_mother").setText(String(calc.worksheetA.mother.L7));
      formA.getTextField("A_L7_father").setText(String(calc.worksheetA.father.L7));

      const wsAFinal = await wsADoc.save();

      // Combine into one downloadable PDF
      const finalDoc = await PDFDocument.create();
      const wsADoc2 = await PDFDocument.load(wsAFinal);
      const wsAPages = await finalDoc.copyPages(wsADoc2, wsADoc2.getPageIndices());
      wsAPages.forEach(p => finalDoc.addPage(p));

      const outBytes = await finalDoc.save();
      const blob = new Blob([outBytes], { type: "application/pdf" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "Montana-Child-Support-Worksheets.pdf";
      a.click();
      URL.revokeObjectURL(url);
    }

    document.getElementById("runBtn").addEventListener("click", async () => {
      const mIncome = +document.getElementById("mIncome").value || 0;
      const mDed    = +document.getElementById("mDed").value || 0;
      const fIncome = +document.getElementById("fIncome").value || 0;
      const fDed    = +document.getElementById("fDed").value || 0;

      const numChildren = +document.getElementById("numChildren").value || 1;
      const childcare   = +document.getElementById("childcare").value || 0;
      const health      = +document.getElementById("health").value || 0;

      const daysA = +document.getElementById("daysA").value || 0;
      const daysB = +document.getElementById("daysB").value || 0;

      const parenting = Array.from({ length: numChildren }).map(() => ({ daysA, daysB }));

      const calc = runMontanaChildSupport({
        mIncome, mDed,
        fIncome, fDed,
        numChildren,
        supplements: { childcare, health, med: 0, other: 0 },
        parenting,
      });

      const out = document.getElementById("out");
      out.style.display = "block";
      out.innerHTML = `
        <b>Engine result:</b><br>
        Final monthly transfer: $${fmt(calc.totalMonthly)} (payer: ${calc.payer || "none"})<br>
        Parent A monthly total: $${fmt(calc.totalMonthlyM)}<br>
        Parent B monthly total: $${fmt(calc.totalMonthlyF)}<br>
        <br>
        Once the PDF templates have real form fields, this button will generate filled worksheets identical to CSSD's packet.
      `;

      await generateWorksheets(calc);
    });
  </script>
</body>
</html>
