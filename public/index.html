<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Montana Child Support Estimator – Guided Wizard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <header class="site-header">
    <div class="brand">
      <div class="logo-circle">MT</div>
      <div>
        <div class="brand-title">Montana Child Support Estimator</div>
        <div class="brand-sub">Unofficial tool – uses CSSD guidelines for estimates only</div>
      </div>
    </div>
  </header>

  <main class="wizard-shell">
    <aside class="wizard-sidebar">
      <ol class="wizard-steps">
        <li data-step-label="1" class="active">Parents & Children</li>
        <li data-step-label="2">Income (W-2 style)</li>
        <li data-step-label="3">Deductions & Other Support</li>
        <li data-step-label="4">Child Costs</li>
        <li data-step-label="5">Parenting Time</li>
        <li data-step-label="6">Review & Results</li>
      </ol>
      <p class="sidebar-note">
        This tool follows the structure of Montana CSSD Worksheets A, B, and C, but is
        not an official CSSD product. Always review final numbers with an attorney or CSSD.
      </p>
    </aside>

    <section class="wizard-main">
      <!-- STEP 1: Parents & children -->
      <section class="wizard-step active" data-step="1">
        <h1>Parents & Children</h1>
        <p>We’ll start with some basic information about the parents and kids involved in this case.</p>

        <div class="grid-2">
          <div>
            <label>
              Parent A name
              <input id="parentAName" type="text" placeholder="Parent A / Mother / Petitioner" />
            </label>
          </div>
          <div>
            <label>
              Parent B name
              <input id="parentBName" type="text" placeholder="Parent B / Father / Respondent" />
            </label>
          </div>
        </div>

        <div class="grid-2">
          <div>
            <label>
              Number of children covered by this order
              <input id="numChildren" type="number" min="1" max="8" value="1" />
            </label>
          </div>
          <div>
            <label>
              Case county (optional)
              <input id="caseCounty" type="text" placeholder="e.g., Missoula, Lewis & Clark" />
            </label>
          </div>
        </div>

        <p class="hint">
          You can use “Parent A / Parent B” instead of Mother/Father if that fits your case better. These labels
          will appear on the summary and worksheets.
        </p>
      </section>

      <!-- STEP 2: Income -->
      <section class="wizard-step" data-step="2">
        <h1>Income – W-2 Style</h1>
        <p>
          Enter annual income for each parent. You can add up all W-2s and other income types.
          Use the same numbers you’d get from tax forms.
        </p>

        <h2>Parent A income (annual)</h2>
        <div class="grid-2">
          <label>
            W-2 Box 1 – wages, tips, other compensation (all jobs)
            <input id="mW2" type="number" step="0.01" />
          </label>
          <label>
            Self-employment net (Schedule C/F, etc.)
            <input id="mSelf" type="number" step="0.01" />
          </label>
        </div>
        <div class="grid-2">
          <label>
            Other taxable income (interest, unemployment, etc.)
            <input id="mOtherTax" type="number" step="0.01" />
          </label>
          <label>
            Other nontaxable income (if counted under guidelines)
            <input id="mOtherNonTax" type="number" step="0.01" />
          </label>
        </div>

        <h2>Parent B income (annual)</h2>
        <div class="grid-2">
          <label>
            W-2 Box 1 – wages, tips, other compensation (all jobs)
            <input id="fW2" type="number" step="0.01" />
          </label>
          <label>
            Self-employment net (Schedule C/F, etc.)
            <input id="fSelf" type="number" step="0.01" />
          </label>
        </div>
        <div class="grid-2">
          <label>
            Other taxable income
            <input id="fOtherTax" type="number" step="0.01" />
          </label>
          <label>
            Other nontaxable income
            <input id="fOtherNonTax" type="number" step="0.01" />
          </label>
        </div>

        <p class="hint">
          Tip: To annualize, multiply monthly amounts by 12, or weekly amounts by 52.
        </p>
      </section>

      <!-- STEP 3: Deductions & other support -->
      <section class="wizard-step" data-step="3">
        <h1>Deductions & Other Support</h1>
        <p>
          These are amounts that Montana’s guidelines allow you to subtract from income
          (taxes, mandatory retirement, support for other children, etc.).
        </p>

        <h2>Parent A deductions (annual)</h2>
        <div class="grid-2">
          <label>
            Federal income tax withheld
            <input id="mFedTax" type="number" step="0.01" />
          </label>
          <label>
            State income tax
            <input id="mStateTax" type="number" step="0.01" />
          </label>
        </div>
        <div class="grid-2">
          <label>
            Social Security tax (FICA)
            <input id="mSS" type="number" step="0.01" />
          </label>
          <label>
            Medicare tax
            <input id="mMedicare" type="number" step="0.01" />
          </label>
        </div>
        <div class="grid-2">
          <label>
            Mandatory retirement contributions
            <input id="mRetire" type="number" step="0.01" />
          </label>
          <label>
            Union dues
            <input id="mUnion" type="number" step="0.01" />
          </label>
        </div>
        <div class="grid-2">
          <label>
            Child support paid for other children (court-ordered)
            <input id="mOtherSupport" type="number" step="0.01" />
          </label>
          <label>
            Alimony paid
            <input id="mAlimony" type="number" step="0.01" />
          </label>
        </div>

        <h2>Parent B deductions (annual)</h2>
        <div class="grid-2">
          <label>
            Federal income tax withheld
            <input id="fFedTax" type="number" step="0.01" />
          </label>
          <label>
            State income tax
            <input id="fStateTax" type="number" step="0.01" />
          </label>
        </div>
        <div class="grid-2">
          <label>
            Social Security tax (FICA)
            <input id="fSS" type="number" step="0.01" />
          </label>
          <label>
            Medicare tax
            <input id="fMedicare" type="number" step="0.01" />
          </label>
        </div>
        <div class="grid-2">
          <label>
            Mandatory retirement contributions
            <input id="fRetire" type="number" step="0.01" />
          </label>
          <label>
            Union dues
            <input id="fUnion" type="number" step="0.01" />
          </label>
        </div>
        <div class="grid-2">
          <label>
            Child support paid for other children (court-ordered)
            <input id="fOtherSupport" type="number" step="0.01" />
          </label>
          <label>
            Alimony paid
            <input id="fAlimony" type="number" step="0.01" />
          </label>
        </div>

        <p class="hint">
          Use annual totals. You may need to convert from paystub “year-to-date” amounts.
        </p>
      </section>

      <!-- STEP 4: Child costs -->
      <section class="wizard-step" data-step="4">
        <h1>Child-Related Costs</h1>
        <p>
          These are costs for the children in this case only. The calculator will split them between parents.
        </p>

        <div class="grid-2">
          <label>
            Work-related childcare (annual, total for these children)
            <input id="childcare" type="number" step="0.01" />
          </label>
          <label>
            Child health insurance premium (annual portion for these children)
            <input id="health" type="number" step="0.01" />
          </label>
        </div>
        <div class="grid-2">
          <label>
            Uninsured medical / therapy (annual)
            <input id="med" type="number" step="0.01" />
          </label>
          <label>
            Other recurring child expenses (annual)
            <input id="otherSupp" type="number" step="0.01" />
          </label>
        </div>

        <p class="hint">
          Do not include costs already counted elsewhere (like adult health insurance or unrelated debt).
        </p>
      </section>

      <!-- STEP 5: Parenting time -->
      <section class="wizard-step" data-step="5">
        <h1>Parenting Time</h1>
        <p>
          Enter the approximate number of days per year each child spends with each parent.
          If parenting time is the same for all children, you can use one set of numbers.
        </p>

        <div class="grid-2">
          <label>
            Days per year with Parent A (each child, if roughly the same)
            <input id="daysA" type="number" step="0.1" value="255" />
          </label>
          <label>
            Days per year with Parent B (each child)
            <input id="daysB" type="number" step="0.1" value="110" />
          </label>
        </div>

        <p class="hint">
          If either parent has more than 110 days per year with a child, Worksheet B&#8217;s shared-parenting
          adjustment may apply. This tool approximates that adjustment.
        </p>
      </section>

      <!-- STEP 6: Review & Results -->
      <section class="wizard-step" data-step="6">
        <h1>Review & Results</h1>
        <p>Review your entries, then run the calculator and generate worksheets.</p>

        <div id="reviewSummary" class="review-box">
          <!-- Filled by JavaScript before calculation -->
        </div>

        <div class="actions-row">
          <button id="calcBtn" type="button" class="primary">Calculate &amp; Generate Worksheets</button>
        </div>

        <div id="resultBox" class="result-box" hidden>
          <!-- Results injected here -->
        </div>
      </section>

      <!-- NAV -->
      <footer class="wizard-nav">
        <button id="backBtn" type="button" class="ghost">Back</button>
        <div class="spacer"></div>
        <button id="nextBtn" type="button" class="primary">Next</button>
      </footer>
    </section>
  </main>

  <footer class="site-footer">
    <p>
      This is an unofficial estimator based on Montana child support guidelines. It does not create a binding order.
      For legal advice, speak with an attorney or contact Montana CSSD.
    </p>
  </footer>

  <script type="module">
    import { runMontanaChildSupport, fmt } from "./engine.js";
    import { generateWorksheets } from "./pdfgen.js";

    const steps = Array.from(document.querySelectorAll(".wizard-step"));
    const stepLabels = Array.from(document.querySelectorAll(".wizard-steps li"));
    const backBtn = document.getElementById("backBtn");
    const nextBtn = document.getElementById("nextBtn");
    const calcBtn = document.getElementById("calcBtn");
    const reviewSummary = document.getElementById("reviewSummary");
    const resultBox = document.getElementById("resultBox");

    let currentStep = 1;
    const maxStep = steps.length;

    function showStep(step) {
      currentStep = Math.min(Math.max(step, 1), maxStep);
      steps.forEach(s => s.classList.toggle("active", Number(s.dataset.step) === currentStep));
      stepLabels.forEach(li => {
        const labelStep = Number(li.dataset.stepLabel);
        li.classList.toggle("active", labelStep === currentStep);
        li.classList.toggle("done", labelStep < currentStep);
      });
      backBtn.disabled = currentStep === 1;
      nextBtn.hidden = currentStep === maxStep;
      if (currentStep === maxStep) {
        nextBtn.hidden = true;
      } else {
        nextBtn.hidden = false;
      }
    }

    backBtn.addEventListener("click", () => showStep(currentStep - 1));
    nextBtn.addEventListener("click", () => {
      if (currentStep === 5) {
        buildReview();
      }
      showStep(currentStep + 1);
    });

    function readNumber(id) {
      const el = document.getElementById(id);
      if (!el) return 0;
      const v = parseFloat(el.value);
      return Number.isFinite(v) ? v : 0;
    }

    function buildReview() {
      const parentAName = document.getElementById("parentAName").value || "Parent A";
      const parentBName = document.getElementById("parentBName").value || "Parent B";
      const numChildren = parseInt(document.getElementById("numChildren").value, 10) || 1;
      const caseCounty = document.getElementById("caseCounty").value || "(not specified)";

      const mIncome =
        readNumber("mW2") +
        readNumber("mSelf") +
        readNumber("mOtherTax") +
        readNumber("mOtherNonTax");

      const fIncome =
        readNumber("fW2") +
        readNumber("fSelf") +
        readNumber("fOtherTax") +
        readNumber("fOtherNonTax");

      const mDed =
        readNumber("mFedTax") +
        readNumber("mStateTax") +
        readNumber("mSS") +
        readNumber("mMedicare") +
        readNumber("mRetire") +
        readNumber("mUnion") +
        readNumber("mOtherSupport") +
        readNumber("mAlimony");

      const fDed =
        readNumber("fFedTax") +
        readNumber("fStateTax") +
        readNumber("fSS") +
        readNumber("fMedicare") +
        readNumber("fRetire") +
        readNumber("fUnion") +
        readNumber("fOtherSupport") +
        readNumber("fAlimony");

      const childcare = readNumber("childcare");
      const health = readNumber("health");
      const med = readNumber("med");
      const otherSupp = readNumber("otherSupp");

      const daysA = readNumber("daysA");
      const daysB = readNumber("daysB");

      reviewSummary.innerHTML = `
        <h2>Quick review</h2>
        <ul>
          <li><strong>Parents:</strong> ${parentAName} &amp; ${parentBName}</li>
          <li><strong>County:</strong> ${caseCounty}</li>
          <li><strong>Children:</strong> ${numChildren}</li>
          <li><strong>${parentAName} income (annual):</strong> $${fmt(mIncome)} | deductions: $${fmt(mDed)}</li>
          <li><strong>${parentBName} income (annual):</strong> $${fmt(fIncome)} | deductions: $${fmt(fDed)}</li>
          <li><strong>Childcare (annual):</strong> $${fmt(childcare)} | health premium: $${fmt(health)}</li>
          <li><strong>Uninsured medical:</strong> $${fmt(med)} | other child costs: $${fmt(otherSupp)}</li>
          <li><strong>Parenting time (per child):</strong> ${daysA} days with ${parentAName}, ${daysB} with ${parentBName}</li>
        </ul>
        <p class="hint">If something looks off, use Back to correct it before calculating.</p>
      `;
    }

calcBtn.addEventListener("click", async () => {
  const parentAName = document.getElementById("parentAName").value || "Parent A";
  const parentBName = document.getElementById("parentBName").value || "Parent B";

  const numChildren = parseInt(document.getElementById("numChildren").value, 10) || 1;

  // INCOME (annual)
  const grossMother =
    readNumber("mW2") +
    readNumber("mSelf") +
    readNumber("mOtherTax") +
    readNumber("mOtherNonTax");

  const grossFather =
    readNumber("fW2") +
    readNumber("fSelf") +
    readNumber("fOtherTax") +
    readNumber("fOtherNonTax");

  // DEDUCTIONS — allowed under CSSD rules
  const otherSupportMother = readNumber("mOtherSupport");
  const otherSupportFather = readNumber("fOtherSupport");

  // CHILD COSTS
  const childcare = readNumber("childcare");
  const health = readNumber("health");
  const med = readNumber("med");
  const otherSupp = readNumber("otherSupp");

  // PARENTING TIME
  const daysA = readNumber("daysA");
  const daysB = readNumber("daysB");

  const parenting = Array.from({ length: numChildren }).map(() => ({
    daysA,
    daysB,
  }));

  // ⭐ NEW ENGINE CALL — EXACT FIELD NAMES REQUIRED
  const calc = runMontanaChildSupport({
    grossMother,
    grossFather,

    otherSupportMother,
    otherSupportFather,

    numChildren,

    childcare,
    health,
    med,
    otherSupp,

    parenting,
  });

  // DETERMINE DISPLAY NAME FOR PAYER
  let payerName = "No transfer (equal obligations)";
  if (calc.payer === "M") payerName = parentAName;
  if (calc.payer === "F") payerName = parentBName;

  // UPDATE RESULTS
  resultBox.hidden = false;
  resultBox.innerHTML = `
    <h2>Estimate results</h2>
    <p><strong>Estimated monthly transfer:</strong> $${fmt(calc.totalMonthly)} (${payerName} pays)</p>
    <p>
      <strong>${parentAName}</strong> monthly obligation: $${fmt(calc.totalMonthlyM)}<br>
      <strong>${parentBName}</strong> monthly obligation: $${fmt(calc.totalMonthlyF)}
    </p>

    <h3>Per-child breakdown</h3>
    <ul>
      ${calc.perChildResults
        .map(
          c => `
            <li>
              Child ${c.childIndex}: ${parentAName} – $${fmt(c.monthlyM)}, 
              ${parentBName} – $${fmt(c.monthlyF)}
              (days: ${c.daysM} with ${parentAName}, ${c.daysF} with ${parentBName})
            </li>
          `
        )
        .join("")}
    </ul>
  `;

  // PDF GENERATION (Worksheet A/B/C)
  try {
    await generateWorksheets(calc, {
      parentAName,
      parentBName,
      numChildren,
      childcare,
      health,
      med,
      otherSupp
    });
  } catch (err) {
    console.warn("PDF generation error:", err);
    alert("Estimate completed. Worksheet PDFs were not generated (template missing or engine mismatch).");
  }
});
    // Initialize
    showStep(1);
  </script>
</body>
</html>
