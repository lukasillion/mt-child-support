<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Montana Child Support Estimator – Public</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:16px;max-width:900px}
    h1{margin-bottom:4px}
    .warn{background:#fff4e5;border-left:4px solid #ffb86b;padding:8px 10px;margin-bottom:10px;font-size:0.9rem}
    fieldset{border:1px solid #ddd;border-radius:8px;padding:10px 12px;margin-bottom:12px}
    legend{font-weight:600;padding:0 4px}
    label{display:block;margin:6px 0;font-size:0.9rem}
    input[type=text],input[type=number],select{width:260px;max-width:100%;padding:4px 6px;box-sizing:border-box}
    small{color:#555}
    button{padding:8px 12px;border-radius:6px;border:1px solid #ccc;background:#0b6efd;color:white;cursor:pointer;font-size:0.9rem}
    button[disabled]{opacity:0.6;cursor:not-allowed}
    .step{display:none}
    .step.active{display:block}
    .nav{display:flex;gap:8px;margin-top:10px}
    .result{margin-top:14px;padding:12px;border-radius:8px;background:#f3f6fb;font-size:0.95rem}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .chip{border-radius:999px;border:1px solid #ccc;padding:4px 10px;font-size:0.8rem;background:#f5f5f5;cursor:pointer}
    .chip.selected{background:#0b6efd;color:white;border-color:#0b6efd}
  </style>
</head>
<body>
  <h1>Montana Child Support Estimator</h1>
  <p><small>Public self-help version – not an official CSSD form. Your answers stay in this browser only.</small></p>

  <div class="warn">
    <strong>Privacy.</strong> Nothing you enter here is sent to a server unless you choose to use the optional W-2 upload feature in a future version. This demo assumes
    you type figures from your pay documents yourself.
  </div>

  <form id="wizard" onsubmit="return false;">
    <!-- STEP 1: Parents & children -->
    <div class="step active" data-step="1">
      <fieldset>
        <legend>Step 1 – Parents & Children</legend>
        <label>Your name (optional)
          <input type="text" id="nameA" placeholder="Parent A">
        </label>
        <label>Other parent's name (optional)
          <input type="text" id="nameB" placeholder="Parent B">
        </label>
        <label>Number of children in this case
          <input type="number" id="numChildren" min="1" max="8" value="1">
        </label>
        <small>Only include children covered by this support order.</small>
      </fieldset>
    </div>

    <!-- STEP 2: Income + W-2 wording -->
    <div class="step" data-step="2">
      <fieldset>
        <legend>Step 2 – Income from W-2 / paystubs</legend>
        <p><strong>Use your W-2 or most recent paystubs.</strong></p>
        <p><small>For W-2s, look at <strong>Box 1 – “Wages, tips, other compensation.”</strong> If you have more than one W-2, add all Box 1 amounts together.</small></p>

        <label>Your total W-2 wages (Box 1, all jobs) – annual $
          <input type="number" id="incomeA" step="0.01" placeholder="e.g. 43500.00">
        </label>

        <label>Other parent's total W-2 wages (Box 1, all jobs) – annual $
          <input type="number" id="incomeB" step="0.01">
        </label>

        <p><small>If you don’t use W-2s, enter your best estimate of yearly income before taxes from all sources.</small></p>

        <hr/>

        <p><strong>Optional (future): auto-fill from W-2</strong></p>
        <label>Upload your W-2 (PDF or image)
          <input type="file" id="w2Upload" accept=".pdf,.png,.jpg,.jpeg">
        </label>
        <button type="button" id="w2Analyze" disabled>Auto-fill from W-2 (coming soon)</button>
        <small id="w2Status"></small>
        <p><small>This button is disabled until an OCR server is configured. Once configured, it will read W-2 Box 1 and other fields automatically.</small></p>
      </fieldset>
    </div>

    <!-- STEP 3: Deductions -->
    <div class="step" data-step="3">
      <fieldset>
        <legend>Step 3 – Taxes & required deductions</legend>
        <p><small>Use your paystubs and W-2. Include amounts that are required, such as:</small></p>
        <ul style="margin-top:4px;padding-left:18px;font-size:0.85rem;">
          <li>Social Security and Medicare taxes</li>
          <li>Federal and state income tax withholding</li>
          <li>Mandatory retirement contributions</li>
          <li>Required union dues</li>
        </ul>

        <label>Your yearly taxes & required deductions (approximate) $
          <input type="number" id="dedA" step="0.01">
        </label>

        <label>Other parent's yearly taxes & required deductions $
          <input type="number" id="dedB" step="0.01">
        </label>

        <small>If you are unsure, you can leave these blank and return later with paystubs.</small>
      </fieldset>
    </div>

    <!-- STEP 4: Child-related costs -->
    <div class="step" data-step="4">
      <fieldset>
        <legend>Step 4 – Child-related costs (yearly)</legend>
        <label>Child care costs for these children (per year) $
          <input type="number" id="childcare" step="0.01" value="0">
        </label>
        <small>Include daycare, after-school programs, or other regular child care expenses.</small>

        <label style="margin-top:10px;">Health insurance premium for these children (per year) $
          <input type="number" id="health" step="0.01" value="0">
        </label>
        <small>Use the part of your health premium that is just for the children in this case, not for adults or other children.</small>
      </fieldset>
    </div>

    <!-- STEP 5: Parenting time -->
    <div class="step" data-step="5">
      <fieldset>
        <legend>Step 5 – Parenting time (days per year)</legend>
        <p><small>Choose the option closest to your parenting schedule. You can adjust the exact days if you know them.</small></p>

        <div class="chips" id="scheduleChips">
          <div class="chip selected" data-type="primaryA">
            Mostly with You (other parent has visits)
          </div>
          <div class="chip" data-type="primaryB">
            Mostly with Other Parent
          </div>
          <div class="chip" data-type="fifty50">
            About 50 / 50
          </div>
        </div>

        <div style="margin-top:10px;">
          <label>Your days with the children per year
            <input type="number" id="daysA" step="0.1" value="255">
          </label>
          <label>Other parent's days with the children per year
            <input type="number" id="daysB" step="0.1" value="110">
          </label>
          <small id="scheduleHint"></small>
        </div>
      </fieldset>
    </div>

    <!-- STEP 6: Review & Calculate -->
    <div class="step" data-step="6">
      <fieldset>
        <legend>Step 6 – Review & calculate</legend>
        <p><small>When you click “Calculate estimate,” this tool uses Montana’s child support rules to estimate a monthly support amount based on the information you entered.</small></p>
        <button type="button" id="calcBtn">Calculate estimate</button>
      </fieldset>
      <div id="result" class="result" style="display:none"></div>
    </div>

    <div class="nav">
      <button type="button" id="backBtn">Back</button>
      <button type="button" id="nextBtn">Next</button>
    </div>
  </form>

  <script type="module">
    import { runMontanaChildSupport, fmt } from "/shared/engine.js";

    // --- Wizard navigation ---
    let currentStep = 1;
    const maxStep = 6;

    function showStep(n) {
      document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
      const el = document.querySelector('.step[data-step="'+n+'"]');
      if (el) el.classList.add('active');
      currentStep = n;
      // toggle nav buttons
      document.getElementById('backBtn').disabled = (n === 1);
      document.getElementById('nextBtn').disabled = (n === maxStep);
    }

    document.getElementById('backBtn').addEventListener('click', () => {
      if (currentStep > 1) showStep(currentStep - 1);
    });
    document.getElementById('nextBtn').addEventListener('click', () => {
      if (currentStep < maxStep) showStep(currentStep + 1);
    });

    // --- Parenting schedule chip behavior ---
    const chipsContainer = document.getElementById('scheduleChips');
    const scheduleHint = document.getElementById('scheduleHint');
    const daysAInput = document.getElementById('daysA');
    const daysBInput = document.getElementById('daysB');

    function setSchedule(type){
      chipsContainer.querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
      const chip = chipsContainer.querySelector('.chip[data-type="'+type+'"]');
      if (chip) chip.classList.add('selected');

      if (type === 'primaryA') {
        daysAInput.value = 255;
        daysBInput.value = 110;
        scheduleHint.textContent = "Example: children live mostly with you, with regular visits to the other parent.";
      } else if (type === 'primaryB') {
        daysAInput.value = 110;
        daysBInput.value = 255;
        scheduleHint.textContent = "Example: children live mostly with the other parent, with your regular visits.";
      } else {
        daysAInput.value = 182.5;
        daysBInput.value = 182.5;
        scheduleHint.textContent = "Example: week-on/week-off or similar 50/50 schedule.";
      }
    }

    chipsContainer.addEventListener('click', (e) => {
      const chip = e.target.closest('.chip');
      if (!chip) return;
      const type = chip.getAttribute('data-type');
      setSchedule(type);
    });
    // initialize hint
    setSchedule('primaryA');

    // --- Calculation ---
    document.getElementById('calcBtn').addEventListener('click', () => {
      const nameA = document.getElementById('nameA').value || 'Parent A';
      const nameB = document.getElementById('nameB').value || 'Parent B';
      const numChildren = Math.max(1, Math.min(8, parseInt(document.getElementById('numChildren').value) || 1));

      const incomeA = parseFloat(document.getElementById('incomeA').value) || 0;
      const incomeB = parseFloat(document.getElementById('incomeB').value) || 0;
      const dedA = parseFloat(document.getElementById('dedA').value) || 0;
      const dedB = parseFloat(document.getElementById('dedB').value) || 0;

      const childcare = parseFloat(document.getElementById('childcare').value) || 0;
      const health = parseFloat(document.getElementById('health').value) || 0;

      const daysA = parseFloat(daysAInput.value) || 0;
      const daysB = parseFloat(daysBInput.value) || 0;

      const parenting = [];
      for (let i = 0; i < numChildren; i++) {
        parenting.push({ daysA, daysB });
      }

      const result = runMontanaChildSupport({
        mIncome: incomeA,
        mDed: dedA,
        fIncome: incomeB,
        fDed: dedB,
        numChildren,
        supplements: { childcare, health, med: 0, other: 0 },
        parenting
      });

      let payerText;
      if (result.totalAnnual === 0) {
        payerText = "This estimate does not suggest a transfer payment.";
      } else {
        const any = result.perChildResults.find(r => r.annual > 0);
        if (any) {
          const payerName = any.payer === 'A' ? nameA : nameB;
          payerText = payerName + " is estimated to pay support.";
        } else {
          payerText = "One parent is estimated to pay support.";
        }
      }

      const div = document.getElementById('result');
      div.style.display = 'block';
      div.innerHTML = `
        <h2>Your estimate</h2>
        <p><strong>Estimated annual transfer:</strong> $${fmt(result.totalAnnual)}</p>
        <p><strong>Estimated monthly transfer:</strong> $${fmt(result.totalMonthly)}</p>
        <p><strong>Who pays?</strong> ${payerText}</p>
        <p><small>This is an estimate based on Montana’s child support guidelines and the information you provided. It is not a court order. 
        You can print this page or save it as a PDF to bring to mediation or court.</small></p>
      `;
      showStep(6);
      window.scrollTo({ top: div.offsetTop - 10, behavior: 'smooth' });
    });

    // NOTE: W-2 OCR button is intentionally disabled until you point it at a real API.
    document.getElementById('w2Analyze').addEventListener('click', () => {
      // when you have an OCR API, enable this button and implement the fetch here
      alert("W-2 auto-fill will be available once the OCR service is connected.");
    });
  </script>
</body>
</html>
